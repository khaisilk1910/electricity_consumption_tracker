# Hướng dẫn:
#   1 - Vào Helpers tạo một input_text với tên : Selected Electricity Consumption Tracker
#   2 - Copy code bên dưới cho vào file config.yaml và lưu file.
#   3 - Vào Developer tools load lại Template Entities hoặc Khởi động lại Hass

template:
  - select:
      - name: "Select Electricity Consumption Tracker"
        unique_id: select_electricity_consumption_tracker_dynamic
        icon: mdi:format-list-numbered
        # 1. State: Hiển thị giá trị hiện tại đang lưu trong input_text
        state: "{{ states('input_text.selected_electricity_consumption_tracker') }}"
        # 2. Options: Dùng Jinja để tạo danh sách tên các entry tự động
        options: >
          {%- set domain = 'electricity_consumption_tracker' -%}
          {%- set entities = integration_entities(domain) -%}
          {# Tạo list chứa các Device ID đã duyệt để tránh trùng lặp #}
          {%- set ns = namespace(scanned_ids=[], option_names=[]) -%}
          
          {%- for entity in entities -%}
            {%- set dev_id = device_id(entity) -%}
            {# Nếu có device_id và chưa quét qua #}
            {%- if dev_id and dev_id not in ns.scanned_ids -%}
              {%- set ns.scanned_ids = ns.scanned_ids + [dev_id] -%}
              
              {# Lấy tên hiển thị (ưu tiên tên user đặt) #}
              {%- set friendly_name = device_attr(dev_id, 'name_by_user') or device_attr(dev_id, 'name') -%}
              
              {# Thêm vào danh sách options #}
              {%- set ns.option_names = ns.option_names + [friendly_name] -%}
            {%- endif -%}
          {%- endfor -%}
          
          {# Trả về mảng JSON cho options #}
          {{ ns.option_names }}

        # 3. Action: Khi người dùng chọn, lưu tên đó vào input_text
        select_option:
          - action: input_text.set_value
            target:
              entity_id: input_text.selected_electricity_consumption_tracker
            data:
              value: "{{ option }}"

  - sensor:
      - name: Selected Device ID Electricity Consumption Tracker
        unique_id: selected_device_id_electricity_consumption_tracker
        icon: mdi:playlist-check
        state: >
          {# Template tìm Device ID dựa trên Tên đang lưu trong Input Text #}
          {%- set selected_name = states('select.select_electricity_consumption_tracker') -%}
          {%- set domain = 'electricity_consumption_tracker' -%}
          {# Lấy danh sách device ID #}
          {%- set entities = integration_entities(domain) -%}
          {%- set ns = namespace(found_id=none) -%}
          {%- for entity in entities -%}
            {# Chỉ tìm nếu chưa thấy kết quả #}
            {%- if ns.found_id is none -%}
              {%- set dev_id = device_id(entity) -%}
              {%- set name = device_attr(dev_id, 'name_by_user') or device_attr(dev_id, 'name') -%}
              {# So sánh tên #}
              {%- if name == selected_name -%}
                {%- set ns.found_id = dev_id -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.found_id }}
        attributes:
          lay_phan_ten_entity_id: >
            {# Template tìm Device ID dựa trên Tên đang lưu trong Input Text #}
            {%- set selected_name = states('select.select_electricity_consumption_tracker') -%}
            {%- set domain = 'electricity_consumption_tracker' -%}
            {# Lấy danh sách device ID #}
            {%- set entities = integration_entities(domain) -%}
            {%- set ns = namespace(found_id=none) -%}
            {%- for entity in entities -%}
              {# Chỉ tìm nếu chưa thấy kết quả #}
              {%- if ns.found_id is none -%}
                {%- set dev_id = device_id(entity) -%}
                {%- set name = device_attr(dev_id, 'name_by_user') or device_attr(dev_id, 'name') -%}
                {# So sánh tên #}
                {%- if name == selected_name -%}
                  {%- set ns.found_id = dev_id -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
            {% set id_cua_entry = ns.found_id %}
            {% set full_entity = device_entities(id_cua_entry)[0] %}
            {{ full_entity.split('.')[1].split('_electricity')[0] }}
          dinh_nghia_ten_entity_id: >
            {% set list1 = ['EVN Bố Electricity Consumption Tracker','EVN Khải Electricity Consumption Tracker','Tongou Tổng Electricity Consumption Tracker'] %}
            {% set list2 = ['Công tơ Bố','Công tơ Khải','Công tơ Tongou Tổng tự theo dõi'] %}
            {# Tạo dictionary map_ten: {'Tên Cũ': 'Tên Mới', ...} #}
            {% set map_ten = dict(zip(list1, list2)) %}
            {# Giá trị đầu vào #}
            {% set input_val = states('select.select_electricity_consumption_tracker') %}

            {# Tra cứu trực tiếp #}
            {{ map_ten.get(input_val, 'Không tìm thấy') }}