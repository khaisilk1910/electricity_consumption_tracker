# HÆ°á»›ng dáº«n:
#   1 - VÃ o Helpers táº¡o hai 
type: vertical-stack
cards:
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-select-card
        entity: select.select_electricity_consumption_tracker
        grid_options:
          columns: full
        layout: horizontal
        name: CÃ´ng tÆ¡
        icon: mdi:transmission-tower-import
        fill_container: true
        icon_color: accent
        secondary_info: none
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-title-card
        title: >-
          ðŸ“ˆ{{
          state_attr('sensor.selected_device_id_electricity_consumption_tracker','dinh_nghia_ten_entity_id')
          }} 
        alignment: start
      - type: custom:config-template-card
        variables:
          var1: >-
            states['sensor.selected_device_id_electricity_consumption_tracker'].attributes.lay_phan_ten_entity_id
        entities:
          - sensor.selected_device_id_electricity_consumption_tracker
        card:
          type: custom:mushroom-template-card
          primary: >-
            âš¡{{ '{:,.0f}'.format(states(entity) | float(2)) | replace('.', ',')
            }} kWh
          secondary: >-
            Tá»•ng sáº£n lÆ°á»£ng {{ state_attr(entity, 'tong_so_thang_du_lieu') }}
            thÃ¡ng
          features_position: bottom
          entity: ${'sensor.'+var1+'_electricity_home_total_all_time'}
          color: red
          vertical: true
          card_mod:
            style: |
              #info {
                --tile-info-primary-font-size:20px !important;
                --tile-info-secondary-font-size: 10px !important;
                --tile-info-secondary-font-weight: bold !important;
                --tile-info-primary-color: #164397 !important;
                --tile-info-secondary-color: #164397 !important;
                 }
  - type: horizontal-stack
    cards:
      - type: custom:config-template-card
        variables:
          var1: >-
            states['sensor.selected_device_id_electricity_consumption_tracker'].attributes.lay_phan_ten_entity_id
        entities:
          - sensor.selected_device_id_electricity_consumption_tracker
        card:
          type: custom:mushroom-template-card
          primary: >-
            {{ '{:,.0f}'.format(state_attr(entity, 'tong_tien_tich_luy') |
            float(0)) | replace('.', ',') }} Ä‘ðŸ’¸
          secondary: TrÆ°á»›c VAT (VND)
          icon: ""
          features_position: bottom
          entity: ${'sensor.'+var1+'_electricity_home_total_all_time'}
          color: red
          card_mod:
            style: |
              #info {
                --tile-info-primary-font-size:20px !important;
                --tile-info-secondary-font-size: 10px !important;
                --tile-info-primary-color: red !important;
                --tile-info-secondary-color: #164397 !important;
                 }
      - type: custom:config-template-card
        variables:
          var1: >-
            states['sensor.selected_device_id_electricity_consumption_tracker'].attributes.lay_phan_ten_entity_id
        entities:
          - sensor.selected_device_id_electricity_consumption_tracker
        card:
          type: custom:mushroom-template-card
          primary: >-
            {{ '{:,.0f}'.format(state_attr(entity,
            'tong_tien_tich_luy_sau_thue') | float(0)) | replace('.', ',') }}
            Ä‘ðŸ’¸
          secondary: Sau VAT (VND)
          icon: ""
          features_position: bottom
          entity: ${'sensor.'+var1+'_electricity_home_total_all_time'}
          color: red
          card_mod:
            style: |
              #info {
                --tile-info-primary-font-size:20px !important;
                --tile-info-secondary-font-size: 10px !important;
                --tile-info-primary-color: red !important;
                --tile-info-secondary-color: #164397 !important;
                 }
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-select-card
        entity: select.select_electricity_year
        fill_container: true
        secondary_info: none
        name: NÄƒm
        layout: horizontal
        icon_color: accent
        icon_type: icon
        icon: mdi:calendar-cursor
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-select-card
        entity: select.select_electricity_month
        name: ThÃ¡ng
        layout: horizontal
        secondary_info: none
        icon_color: accent
        icon_type: icon
        icon: mdi:calendar-cursor-outline
  - type: horizontal-stack
    cards:
      - type: custom:config-template-card
        variables:
          var1: states['select.select_electricity_year'].state
          var2: states['select.select_electricity_month'].state
          var3: >-
            states['sensor.selected_device_id_electricity_consumption_tracker'].attributes.lay_phan_ten_entity_id
        entities:
          - select.select_electricity_year
          - select.select_electricity_month
          - sensor.selected_device_id_electricity_consumption_tracker
        card:
          type: custom:apexcharts-card
          header:
            show: true
            title: ${'ðŸ“Š Chi tiáº¿t T'+var2+'/'+var1}
            show_states: true
            colorize_states: true
            standard_format: false
          graph_span: 31d
          span:
            start: month
          series:
            - entity: >-
                ${'sensor.' + var3 + '_electricity_home_thang_' + var2 + '_' +
                var1}
              type: column
              name: HÃ´m nay
              unit: kWh
              color: "#164397"
              float_precision: 2
              show:
                datalabels: false
                extremas: true
                in_header: false
              data_generator: |
                const details = entity.attributes.chi_tiet_ngay;
                const data = [];
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth(); // 0 = ThÃ¡ng 1

                // Duyá»‡t qua tá»«ng key (Ngay_1, Ngay_2...)
                for (const [key, value] of Object.entries(details)) {
                  if (key.startsWith('Ngay_')) {
                    const day = parseInt(key.split('_')[1]);
                    // Táº¡o timestamp cho ngÃ y Ä‘Ã³ lÃºc 00:00
                    const date = new Date(currentYear, currentMonth, day).getTime();
                    data.push([date, value]);
                  }
                }
                // Sáº¯p xáº¿p theo ngÃ y tÄƒng dáº§n
                return data.sort((a, b) => a[0] - b[0]);
            - entity: >-
                ${'sensor.' + var3 + '_electricity_home_thang_' + var2 + '_' +
                var1}
              name: Tá»•ng sáº£n lÆ°á»£ng
              color: "#164397"
              type: column
              unit: âš¡
              yaxis_id: hidden_scale
              show:
                in_chart: false
                in_header: true
              data_generator: |
                // Láº¥y giÃ¡ trá»‹ tá»« attribute
                const val = parseFloat(entity.attributes.tong_san_luong_kwh);
                // Tráº£ vá» máº£ng chá»©a 1 Ä‘iá»ƒm dá»¯ liá»‡u táº¡i thá»i Ä‘iá»ƒm hiá»‡n táº¡i
                return [[new Date().getTime(), val]];
            - entity: >-
                ${'sensor.' + var3 + '_electricity_home_thang_' + var2 + '_' +
                var1}
              name: Tá»•ng trÆ°á»›c VAT
              color: red
              unit: ðŸ’¸
              float_precision: 0
              yaxis_id: hidden_scale
              show:
                in_chart: false
                in_header: true
              data_generator: |
                // Láº¥y giÃ¡ trá»‹ tá»« attribute
                const val = parseFloat(entity.state);
                // Tráº£ vá» máº£ng chá»©a 1 Ä‘iá»ƒm dá»¯ liá»‡u táº¡i thá»i Ä‘iá»ƒm hiá»‡n táº¡i
                return [[new Date().getTime(), val]];
            - entity: >-
                ${'sensor.' + var3 + '_electricity_home_thang_' + var2 + '_' +
                var1}
              name: Tá»•ng sau VAT
              color: red
              type: column
              unit: ðŸ’¸
              float_precision: 0
              yaxis_id: hidden_scale
              show:
                in_chart: false
                in_header: true
              data_generator: |
                // Láº¥y giÃ¡ trá»‹ tá»« attribute
                const val = parseFloat(entity.attributes.tong_tien_sau_thue);
                // Tráº£ vá» máº£ng chá»©a 1 Ä‘iá»ƒm dá»¯ liá»‡u táº¡i thá»i Ä‘iá»ƒm hiá»‡n táº¡i
                return [[new Date().getTime(), val]];
          yaxis:
            - min: 0
              decimals: 0
              apex_config:
                tickAmount: 5
                labels:
                  show: true
                  style:
                    colors: "#164397"
                forceNiceScale: true
          apex_config:
            chart:
              height: 200px
            plotOptions:
              bar:
                columnWidth: 60%
                borderRadius: 2
            xaxis:
              tooltip:
                enabled: false
              labels:
                format: dd/MM
            tooltip:
              x:
                format: dd
  - type: custom:config-template-card
    variables:
      var1: states['select.select_electricity_year'].state
      var3: >-
        states['sensor.selected_device_id_electricity_consumption_tracker'].attributes.lay_phan_ten_entity_id
    entities:
      - select.select_electricity_year
      - sensor.selected_device_id_electricity_consumption_tracker
    card:
      type: custom:apexcharts-card
      header:
        show: true
        title: ${'ðŸ“Š Thá»‘ng kÃª ' + var1}
        show_states: true
        colorize_states: true
      graph_span: 1y
      span:
        start: year
        offset: >-
          ${ var diff = parseInt(var1) - new Date().getFullYear(); diff === 0 ?
          '' : diff + 'y'; }
      apex_config:
        legend:
          show: false
          position: top
        chart:
          height: 200
          stacked: false
        plotOptions:
          bar:
            columnWidth: 65%
            dataLabels:
              position: top
        xaxis:
          type: datetime
          format: MM
          tooltip:
            enabled: false
        tooltip:
          enabled: true
          shared: true
          intersect: false
          x:
            format: MM
      yaxis:
        - id: kwh
          show: true
          decimals: 0
          min: 0
          apex_config:
            labels:
              show: true
              style:
                colors: "#164397"
            forceNiceScale: true
        - id: vnd
          show: true
          opposite: true
          decimals: 0
          min: 0
          apex_config:
            forceNiceScale: true
            labels:
              show: true
              style:
                colors: red
              formatter: |
                EVAL:function(val) {
                  if (val >= 1000000) return (val / 1000000).toFixed(1) + ' tr';
                  if (val >= 1000) return (val / 1000).toFixed(0) + ' k';
                  return val;
                }
        - id: hidden_scale
          show: false
          min: 0
          max: 10000000000
      series:
        - entity: ${'sensor.' + var3 + '_electricity_home_nam_' + var1}
          name: Sáº£n lÆ°á»£ng
          type: column
          unit: kWh
          color: "#164397"
          yaxis_id: kwh
          float_precision: 1
          show:
            datalabels: false
            extremas: false
            legend_value: false
            in_header: false
          data_generator: |
            const data = entity.attributes.chi_tiet_cac_thang;
            if (!data) return [];
            // Láº¥y nÄƒm tá»« tÃªn entity
            const year = entity.entity_id.split('_').pop(); 
            let chartData = [];
            // Cháº¡y vÃ²ng láº·p cá»‘ Ä‘á»‹nh 12 thÃ¡ng
            for (let i = 1; i <= 12; i++) {
              const key = 'Thang_' + i;
              // Táº¡o timestamp ngÃ y 1 cá»§a thÃ¡ng tÆ°Æ¡ng á»©ng
              const date = new Date(year, i - 1, 1).getTime();
              let val = 0;
              // Náº¿u cÃ³ dá»¯ liá»‡u trong attribute thÃ¬ láº¥y, khÃ´ng thÃ¬ Ä‘á»ƒ 0
              if (data[key]) {
                val = data[key].san_luong_kwh || 0;
              }
              chartData.push([date, val]);
            }
            return chartData;
        - entity: ${'sensor.' + var3 + '_electricity_home_nam_' + var1}
          name: Tiá»n
          type: column
          unit: Ä‘
          color: red
          yaxis_id: vnd
          float_precision: 0
          show:
            datalabels: false
            extremas: true
            legend_value: false
            in_header: false
          data_generator: |
            const data = entity.attributes.chi_tiet_cac_thang;
            if (!data) return [];
            const year = entity.entity_id.split('_').pop();
            let chartData = [];
            // Cháº¡y vÃ²ng láº·p cá»‘ Ä‘á»‹nh 12 thÃ¡ng
            for (let i = 1; i <= 12; i++) {
              const key = 'Thang_' + i;
              const date = new Date(year, i - 1, 1).getTime();
              let money = 0;
              if (data[key]) {
                 money = data[key].thanh_tien_vnd || 0;
              }
              chartData.push([date, money]);
            }
            return chartData;
        - entity: ${'sensor.' + var3 + '_electricity_home_nam_' + var1}
          name: Tá»•ng Sáº£n lÆ°á»£ng
          color: "#164397"
          unit: âš¡
          yaxis_id: hidden_scale
          show:
            in_chart: false
            in_header: true
          data_generator: |
            // Láº¥y giÃ¡ trá»‹ tá»« attribute
            const val = parseFloat(entity.attributes.tong_san_luong_nam);
            // Tráº£ vá» máº£ng chá»©a 1 Ä‘iá»ƒm dá»¯ liá»‡u táº¡i thá»i Ä‘iá»ƒm hiá»‡n táº¡i
            return [[new Date().getTime(), val]];
        - entity: ${'sensor.' + var3 + '_electricity_home_nam_' + var1}
          name: Tá»•ng trÆ°á»›c VAT
          color: red
          unit: ðŸ’¸
          float_precision: 0
          yaxis_id: hidden_scale
          show:
            in_chart: false
            in_header: true
          data_generator: |
            // Láº¥y giÃ¡ trá»‹ tá»« attribute
            const val = parseFloat(entity.state);
            // Tráº£ vá» máº£ng chá»©a 1 Ä‘iá»ƒm dá»¯ liá»‡u táº¡i thá»i Ä‘iá»ƒm hiá»‡n táº¡i
            return [[new Date().getTime(), val]];
        - entity: ${'sensor.' + var3 + '_electricity_home_nam_' + var1}
          name: Tá»•ng sau VAT
          color: red
          unit: ðŸ’¸
          float_precision: 0
          yaxis_id: hidden_scale
          show:
            in_chart: false
            in_header: true
          data_generator: |
            // Láº¥y giÃ¡ trá»‹ tá»« attribute
            const val = parseFloat(entity.attributes.tong_tien_sau_thue);
            // Tráº£ vá» máº£ng chá»©a 1 Ä‘iá»ƒm dá»¯ liá»‡u táº¡i thá»i Ä‘iá»ƒm hiá»‡n táº¡i
            return [[new Date().getTime(), val]];
    grid_options:
      columns: full
grid_options:
  columns: full

