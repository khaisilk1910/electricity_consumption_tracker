type: vertical-stack
cards:
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-template-card
        primary: >-
          Tổng Sản lượng của {{ state_attr(entity,'tong_so_thang_du_lieu') }}
          Tháng
        features_position: bottom
        entity: sensor.tongou_tong_electricity_home_total_all_time
        secondary: "{{ \"{:,.2f}\".format(states(entity) | float(0)) }} kWh"
        color: red
        multiline_secondary: false
        vertical: true
  - type: horizontal-stack
    cards:
      - type: tile
        entity: sensor.tongou_tong_electricity_home_total_all_time
        name: Trước VAT (VND)
        icon: mdi:cash-100
        color: red
        show_entity_picture: false
        state_content: tong_tien_tich_luy
        vertical: false
        features_position: bottom
      - type: tile
        entity: sensor.tongou_tong_electricity_home_total_all_time
        name: Sau VAT (VND)
        icon: mdi:cash-100
        color: red
        show_entity_picture: false
        state_content: tong_tien_tich_luy_sau_thue
        vertical: false
        features_position: bottom
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-select-card
        entity: input_select.tongou_electricity_bill_select_year
        fill_container: true
        secondary_info: none
        name: Năm
        layout: horizontal
        icon_color: red
        icon_type: icon
        icon: mdi:calendar-cursor
      - type: custom:mushroom-select-card
        entity: input_select.tongou_electricity_bill_select_month
        name: Tháng
        layout: horizontal
        secondary_info: none
        icon_color: red
        icon_type: icon
        icon: mdi:calendar-cursor-outline
  - type: horizontal-stack
    cards:
      - type: custom:config-template-card
        variables:
          var1: states['input_select.tongou_electricity_bill_select_year'].state
          var2: states['input_select.tongou_electricity_bill_select_month'].state
        entities:
          - input_select.tongou_electricity_bill_select_year
          - input_select.tongou_electricity_bill_select_month
        card:
          type: custom:apexcharts-card
          header:
            show: true
            title: ${'Chi tiết T'+var2+'/'+var1}
            show_states: true
            colorize_states: true
            standard_format: false
          graph_span: 31d
          span:
            start: month
          series:
            - entity: >-
                ${'sensor.tongou_tong_electricity_home_thang_' + var2 + '_' +
                var1}
              type: column
              name: Hôm nay
              unit: kWh
              color: red
              float_precision: 2
              show:
                datalabels: false
                extremas: true
                in_header: true
              data_generator: |
                const details = entity.attributes.chi_tiet_ngay;
                const data = [];
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth(); // 0 = Tháng 1

                // Duyệt qua từng key (Ngay_1, Ngay_2...)
                for (const [key, value] of Object.entries(details)) {
                  if (key.startsWith('Ngay_')) {
                    const day = parseInt(key.split('_')[1]);
                    // Tạo timestamp cho ngày đó lúc 00:00
                    const date = new Date(currentYear, currentMonth, day).getTime();
                    data.push([date, value]);
                  }
                }
                // Sắp xếp theo ngày tăng dần
                return data.sort((a, b) => a[0] - b[0]);
            - entity: >-
                ${'sensor.tongou_tong_electricity_home_thang_' + var2 + '_' +
                var1}
              name: Tổng sản lượng
              color: red
              type: column
              unit: kWh
              yaxis_id: hidden_scale
              show:
                in_chart: false
                in_header: true
              data_generator: |
                // Lấy giá trị từ attribute
                const val = parseFloat(entity.attributes.tong_san_luong_kwh);
                // Trả về mảng chứa 1 điểm dữ liệu tại thời điểm hiện tại
                return [[new Date().getTime(), val]];
            - entity: >-
                ${'sensor.tongou_tong_electricity_home_thang_' + var2 + '_' +
                var1}
              name: Tổng Tiền
              color: red
              type: column
              unit: đ
              float_precision: 0
              yaxis_id: hidden_scale
              show:
                in_chart: false
                in_header: true
          yaxis:
            - min: 0
              decimals: 0
              apex_config:
                tickAmount: 5
          apex_config:
            chart:
              height: 200px
            plotOptions:
              bar:
                columnWidth: 60%
                borderRadius: 2
            xaxis:
              tooltip:
                enabled: false
              labels:
                format: dd/MM
            tooltip:
              x:
                format: dd
  - type: custom:config-template-card
    variables:
      var1: states['input_select.tongou_electricity_bill_select_year'].state
    entities:
      - input_select.tongou_electricity_bill_select_year
    card:
      type: custom:apexcharts-card
      header:
        show: true
        title: ${'Thống kê ' + var1}
        show_states: true
        colorize_states: true
      graph_span: 1y
      span:
        start: year
        offset: >-
          ${ var diff = parseInt(var1) - new Date().getFullYear(); diff === 0 ?
          '' : diff + 'y'; }
      apex_config:
        legend:
          show: false
          position: top
        chart:
          height: 200
          stacked: false
        plotOptions:
          bar:
            columnWidth: 65%
            dataLabels:
              position: top
        xaxis:
          type: datetime
          format: MM
          tooltip:
            enabled: false
        tooltip:
          enabled: true
          shared: true
          intersect: false
          x:
            format: MM
      yaxis:
        - id: kwh
          show: true
          decimals: 0
          min: 0
          apex_config:
            labels:
              show: true
              style:
                colors: "#164397"
            forceNiceScale: true
        - id: vnd
          show: true
          opposite: true
          decimals: 0
          min: 0
          apex_config:
            forceNiceScale: true
            labels:
              show: true
              style:
                colors: red
              formatter: |
                EVAL:function(val) {
                  if (val >= 1000000) return (val / 1000000).toFixed(1) + ' tr';
                  if (val >= 1000) return (val / 1000).toFixed(0) + ' k';
                  return val;
                }
        - id: hidden_scale
          show: false
          min: 0
          max: 10000000000
      series:
        - entity: ${'sensor.tongou_tong_electricity_home_nam_' + var1}
          name: Sản lượng
          type: column
          unit: kWh
          color: "#164397"
          yaxis_id: kwh
          float_precision: 1
          show:
            datalabels: false
            extremas: false
            legend_value: false
            in_header: false
          data_generator: |
            const data = entity.attributes.chi_tiet_cac_thang;
            if (!data) return [];
            // Lấy năm từ tên entity
            const year = entity.entity_id.split('_').pop(); 
            let chartData = [];
            // Chạy vòng lặp cố định 12 tháng
            for (let i = 1; i <= 12; i++) {
              const key = 'Thang_' + i;
              // Tạo timestamp ngày 1 của tháng tương ứng
              const date = new Date(year, i - 1, 1).getTime();
              let val = 0;
              // Nếu có dữ liệu trong attribute thì lấy, không thì để 0
              if (data[key]) {
                val = data[key].san_luong_kwh || 0;
              }
              chartData.push([date, val]);
            }
            return chartData;
        - entity: ${'sensor.tongou_tong_electricity_home_nam_' + var1}
          name: Tiền
          type: column
          unit: đ
          color: red
          yaxis_id: vnd
          float_precision: 0
          show:
            datalabels: false
            extremas: true
            legend_value: false
            in_header: false
          data_generator: |
            const data = entity.attributes.chi_tiet_cac_thang;
            if (!data) return [];
            const year = entity.entity_id.split('_').pop();
            let chartData = [];
            // Chạy vòng lặp cố định 12 tháng
            for (let i = 1; i <= 12; i++) {
              const key = 'Thang_' + i;
              const date = new Date(year, i - 1, 1).getTime();
              let money = 0;
              if (data[key]) {
                 money = data[key].thanh_tien_vnd || 0;
              }
              chartData.push([date, money]);
            }
            return chartData;
        - entity: ${'sensor.tongou_tong_electricity_home_nam_' + var1}
          name: Tổng Sản lượng
          color: "#164397"
          unit: kWh
          yaxis_id: hidden_scale
          show:
            in_chart: false
            in_header: true
          data_generator: |
            // Lấy giá trị từ attribute
            const val = parseFloat(entity.attributes.tong_san_luong_nam);
            // Trả về mảng chứa 1 điểm dữ liệu tại thời điểm hiện tại
            return [[new Date().getTime(), val]];
        - entity: ${'sensor.tongou_tong_electricity_home_nam_' + var1}
          name: Trước VAT
          color: red
          unit: đ
          float_precision: 0
          yaxis_id: hidden_scale
          show:
            in_chart: false
            in_header: true
          data_generator: |
            // Lấy giá trị từ attribute
            const val = parseFloat(entity.state);
            // Trả về mảng chứa 1 điểm dữ liệu tại thời điểm hiện tại
            return [[new Date().getTime(), val]];
        - entity: ${'sensor.tongou_tong_electricity_home_nam_' + var1}
          name: Sau VAT
          color: red
          unit: đ
          float_precision: 0
          yaxis_id: hidden_scale
          show:
            in_chart: false
            in_header: true
          data_generator: |
            // Lấy giá trị từ attribute
            const val = parseFloat(entity.attributes.tong_tien_sau_thue);
            // Trả về mảng chứa 1 điểm dữ liệu tại thời điểm hiện tại
            return [[new Date().getTime(), val]];
    grid_options:
      columns: full
grid_options:
  columns: full
